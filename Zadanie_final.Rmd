---
title: "OZNAL - zadanie 1"
author: "Daniel Cok, Jakub Abrahoim"
output: html_document
editor_options: 
  markdown: 
    wrap: sentence
---

Ako dataset sme zvolili štatistiky hráčov z NHL, ktorý je dostupný [tu](https://www.kaggle.com/datasets/alexbenzik/nhl-players-statistics?resource=download&select=NHL_Players_Statistics.csv).
Dataset obsahuje dáta o hráčoch NHL z viacerých sezón

# Načítanie knižníc

```{r}
library(tidyverse)
library(magrittr)
library(data.table) # Pre %like% operátor
library(caret) # Pre confusionMatrix
library(pROC)

```

# Načítanie dát

```{r}
getwd()
setwd("/Users/danielcok/xcok/4.semester/OZNAL/Zadanie") # 
data <- read_delim("NHL_Players_Statistics.csv", col_names = TRUE, num_threads = 4, delim = ';');
data
view(data)
```

# Úprava dát

Ako prvé sme upravili názvy stĺpcov, aby boli konzistentné nakoľko niektoré boli all caps a niektoré nie.
Taktiež sme niektoré premenovali, aby boli jasnejšie.

```{r}
colnames(data) # Pôvodné mená stĺpcov

new_colnames <- c("player_name", "date_of_birth", "season_year", "season", "team", "games_played", "goals", "assists", "points", "plus_minus_ratings", "penalty_minutes",
                "shots_on_goal", "shooting_percentage", "power_play_goals", "power_play_assists", "short_goals", "short_assists", "game_winning_goals", "game_tying_goals",
                "time_on_ice_per_game", "production", "number", "games_started", "wins", "losses", "ties", "overtime_losses", "goals_against", "goals_against_average", "shots_against", "saves",
                "save_percentage", "shutouts", "position", "height", "weight", "bmi", "place_of_birth", "age", "experience")

colnames(data) <- new_colnames

colnames(data) # Nové mená stĺpcov
```

Stĺpec `date_of_birth` rozdelíme na 3 stĺpce `Year`, `Month` a `Day` nakoľko to boli 3 hodnoty v jednej bunke (zachovanie princípu tidy dát).

```{r}
data %<>% separate("date_of_birth", into = c("Year", "Month", "Day"), sep = "-")
```

Stĺpec `place_of_birth` rozdelíme na 2 stĺpce `city` a `state` nakoľko to boli 2 hodnoty v jednej bunke (zachovanie princípu tidy dát).
Ak mal hráč iba mesto, tak `state` bude automaticky `NA`.

```{r}
data %<>% separate("place_of_birth", into = c("city", "state"), sep = ",")
```

Odstránenie apostrofov z hodnôt v stĺpci `season`.
Dáta v tomto sĺpci boli formátované ako '<číslo>-'<číslo>.
Apostrofy nám prišli zbytočné a tak sme ich odstránili pre lepšiu čitateľnosť.

```{r}
data$season <- gsub("'", "", data$season) # Funkcia gsub funguje podobne ako sub ale nahradí všetky výskyty
```

Odstránenie invalid values zo sĺpcov nakoľko pri analýze datasetu sme objavili, že niektoré bunky v daných sĺpcoch obsahujú `Invalid Number`.
Nahradíme ich za `0`.

```{r}
data$game_tying_goals[is.na(data$game_tying_goals)] <- 0
data$number[is.na(data$number)] <- 0
data$goals[is.na(data$goals)] <- 0
data$assists[is.na(data$assists)] <- 0
data$points[is.na(data$points)] <- 0
data$plus_minus_ratings[is.na(data$plus_minus_ratings)] <- 0
data$penalty_minutes[is.na(data$penalty_minutes)] <- 0
data$shots_on_goal[is.na(data$shots_on_goal)] <- 0
data$shooting_percentage[is.na(data$shooting_percentage)] <- 0
data$power_play_goals[is.na(data$power_play_goals)] <- 0
data$power_play_assists[is.na(data$power_play_assists)] <- 0
data$short_goals[is.na(data$short_goals)] <- 0
data$short_assists[is.na(data$short_assists)] <- 0
data$game_winning_goals[is.na(data$game_winning_goals)] <- 0
```

Pridelenie role podľa pozície hráča.
- Za ofenzívnych hráčov budeme považovať hráčov na pozíciách `Right_wing`, `Left_wing`, `Center` a `Forward`.
- Za defenzívnych hráčov budeme považovať hráčov na pozíciách `Defence`.
- Brankárov budeme považovať za brankárov (`Goaltender`).

```{r}
# Získame unikátne hodnoty z pozícií hráčov
unique(data$position)
data %<>% mutate(
  role = case_when(
    position %like% "Right_wing|Left_wing|Center|Forward" ~ "offensive",
    position %like% "Defence" ~ "defensive",
    position %like% "Goaltender" ~ "goalie",
    .default = "goalie"
  )
)
```

Zobrazenie dát po úprave.

```{r}
view(data)
```

# Lineárna regresia

Ako prvé sme si vybrali niektoré sĺpce z datasetu a použili funkciu plot na vykreslenie grafov.
Ako závislú (dependent) premennú sme si zvolili `goals` a ako nezávislé (independent) premenné sme si zvolili `shots_on_goal`, `shooting_percentage`.
Vychádzali sme z výstupu príkazu `plot` ale aj logického odhadu, že tieto premenné by mohli mať vplyv na počet gólov.
- `goals` - počet gólov - `shots_on_goal` - počet striel na bránu - `shooting_percentage` - percentuálna úspešnosť striel

```{r}
selected_data <- data %>% select(goals, shots_on_goal, shooting_percentage, power_play_goals)
plot(selected_data)
#boxplot(selected_data)
```

Hypotézy: - H_0 - Strely na bránu majú pozitívny vplyv na počet gólov - H_1 - Percentuálna úspešnosť striel má pozitívny vplyv na počet gólov

Pri lineárnej regresii budeme uvažovať ofenzívnych a defenzívnych hráčov, nakoľko v reálnych hokejových zápasoch často skóruju obe tieto skupiny.
Brankárov brať do úvahy nebudeme.
Preto sme si najprv vyfiltrovali dáta pomocou funkcie `filter` a vybrali iba ofenzívnych a defenzívnych hráčov podľa sĺpcu `role`, ktorý sme si vyššie vytvorili.
Následne sme si rozdelili dáta na trénovacie a testovacie v pomere 7:3 a následne sme vytvorili lineárny model pomocou funkcie `lm`.

```{r}
# Filter na offensive a defensive
filtered_data <- data %>% filter(role == "offensive" | role == "defensive")

sample <- sample(c(TRUE, FALSE), nrow(filtered_data), replace=TRUE, prob=c(0.7,0.3))
train <- filtered_data[sample, ]
test <- filtered_data[!sample, ]

model <- lm(goals ~ shots_on_goal + shooting_percentage, data = train)
summary(model)
```

Interpretácia modelu:

-   **Residuals** - Reziduály, ktoré nám udávajú rozdiel medzi skutočnými hodnotami závislej premennej a hodnotami modelu - median - 0.027
-   **Coefficients** - Koeficienty
    -   **Incercept** - Hodnota y, keď x je rovné 0. Čiže ak hráč nemá žiadne striely na bránu a jeho percentuálna úspešnosť striel je 0, tak stále môžme očakávať priemerne -3.13 gólov (v reálnom živote to bude 0).
    -   **shots_on_goal** - Pri zvýšení počtu striel na bránu o 1, očakávame zvýšenie počtu gólov o 0.1056 s chybou priemerne (0.0005).
    -   **shooting_percentage** - Pri zvýšení percentuálnej úspešnosti striel o 1%, očakávame zvýšenie počtu gólov o 0.2998 s chybou priemerne (0.00049).
    -   **P values** - P hodnoty, ktoré nám hovoria, či je daný koeficient štatisticky významný. V našom prípade sú oba koeficienty štatisticky významné (\<0.05) a teda hypotézy H_0 a H_1 nezamietame resp. prijímame.
-   **Residual standard error** - Štandardná odchýlka reziduálov - 4.093
-   **Multiple R squared** - Vyjadruje ako dobre sa model prispôsobuje dátam. Čím bližšie k 1 tým lepšie. V našom prípade 0.807.

Reziduály:

Vykreslenie reziduálov pomocou funkcie `plot`.

```{r}
par(mfrow = c(1,3)) # Vytvorí grid 1x3
plot(model, which = c(1,2,5))
```

-   Prvý graf nám ukazuje reziduály (os x) a predikované hodnoty (fitted values)
-   Druhý graf nám ukazuje normálny Q-Q graf, ktorý nám ukazuje, či sú reziduály normálne distribuované - v našom prípade to nie je úplne ideálna distribúcia
-   Tretí graf nám ukazuje reziduály vs leverage - zobrazuje nám outliery a high leverage points. V prípade, že by sme high leverage points z datasetu odstránili tak by to značne ovlypnilo koeficienty.

Výpočet RSS (residual sum of squares) a RMSE (root mean squared error).
\* RSS - Suma/súčet druhej mocniny vzdialenosti medzi skutočnými hodnotami a predikovanými hodnotami.
Čím nižšie RSS tým lepší model.
\* RMSE - Odmocnina priemeru druhej mocniny residuálov.
Priemerný rozdiel (chyba) medzi skutočnými hodnotami a predikovanými hodnotami.
Čím nižšie RMSE tým lepší model.

```{r}
# Pre trénovacie dáta
residuals <- model$residuals
RSS <- sum(residuals^2)
RSS
RMSE <- sqrt(mean(residuals^2))
RMSE

# Pre testovacie dáta
predictions <- predict(model, test)
residuals_test <- test$goals - predictions
#RSS_test <- sum(residuals_test^2)
#RSS_test
RMSE_test <- RMSE(predictions, test$goals)
RMSE_test
```

# Klasifikacia

```{r}
# Vytvorenie stĺpca role_oneHot na základe pozície
data <- data %>% 
  mutate(
    role_oneHot = if_else(role == "offensive", 1, 0)
  )

```

# Hypotézy

-   **H0** : Počet gólov  má pozitivny vplyv na pravdepodobnosť byť klasifikovaný ako ofenzívny hráč.

-   **H1** : Asistencie maju negativny vplyv na pravdepodobnosť byť klasifikovaný ako ofenzívny hráč.

```{r}
# Rozdelenie dát na trenovaciu a testovaciu súpravu
set.seed(123)  
training_indices <- createDataPartition(data$role_oneHot, p = 0.7, list = FALSE)  
train_data <- data[training_indices, ]  
test_data <- data[-training_indices, ]  

```

set.seed(123): Toto nastaví náhodný generátor čísel na konkrétnu hodnotu (123), aby bolo možné reprodukovanie rozdelenia dát; to znamená, že vždy keď tento kód spustíte, dostanete rovnaké rozdelenie dát.

createDataPartition(data\$role_oneHot, p = 0.7, list = FALSE): Funkcia createDataPartition z knižnice caret rozdelí dátový rámec tak, že 70% dát (ako je uvedené v p = 0.7) sa použije na trénovanie modelu a zvyšok (30%) na jeho testovanie.
Argument list = FALSE hovorí, že funkcia by mala vrátiť priamo indexy namiesto zoznamu indexov.

train_data \<- data[training_indices, ]: Tento riadok vytvorí trénovaciu súpravu použitím indexov vrátených createDataPartition.

test_data \<- data[-training_indices, ]: Podobne tento riadok vytvorí testovaciu súpravu použitím zvyšných indexov, ktoré neboli vybrané pre trénovanie.

```{r}
# Vytvorenie logistického regresného modelu
model <- glm(role_oneHot ~ goals + assists , data = train_data, family = "binomial")  
```

Funkcia glm (Generalized Linear Model) sa používa na vytvorenie modelu, pričom role_oneHot \~ .
znamená, že model sa bude snažiť predpovedať premennú role_oneHot na základe všetkých ostatných premenných v trénovacích dátach train_data.
Argument family = "binomial" špecifikuje, že sa jedná o binomickú logistickú regresiu, ktorá sa používa pre binárne (dve hodnoty) závislé premenné.

```{r}
# Predikcie a hodnotenie
predictions <- predict(model, test_data, type = "response")  
predicted_class <- if_else(predictions > 0.5, 1, 0)  
```

Výpočet predikcií pomocou funkcie predict, kde argument type = "response" znamená, že predikcie sú na škále pravdepodobnosti, čiže hodnoty medzi 0 a 1, kde hodnoty bližšie k 1 indikujú väčšiu istotu, že pozorovanie patrí do pozitívnej triedy (často označovanej ako 1).

Vytvorenie predpovedanej triedy predicted_class pomocou funkcie if_else, kde sa prahová hodnota 0.5 používa na určenie, či by malo byť pozorovanie klasifikované ako pozitívne (1) alebo negatívne (0).
Ak je predpovedaná pravdepodobnosť väčšia ako 0.5, pozorovanie sa klasifikuje ako pozitívne; inak sa klasifikuje ako negatívne.

```{r}
# Confusion matrix
cm <- confusionMatrix(as.factor(predicted_class), as.factor(test_data$role_oneHot))
print(cm)  
```

## Klasifikacia

Model používa počet striel na bránku a percento úspešnosti striel na predpovedanie počtu gólov.
Všetky koeficienty sú štatisticky významné s p-hodnotami menšími ako 2e-16, čo naznačuje silný štatistický vplyv týchto príznakov na počet gólov.
Koeficient pre počet striel na bránku (shots_on_goal) je pozitívny, čo znamená, že s vyšším počtom striel na bránku sa očakáva vyšší počet gólov.
Koeficient pre percento úspešnosti striel (shooting_percentage) je tiež pozitívny, naznačujúci, že hráči s vyšším percentom úspešnosti striel majú tendenciu skórovať viac gólov.
Multiple R-squared hodnota 0.8092 ukazuje, že model dobre vysvetľuje variabilitu v počte gólov, čo je považované za veľmi dobré prispôsobenie modelu.

Logistická regresia a Confusion Matrix: Presnosť modelu sa zlepšila na 0.66, čo je lepšie v porovnaní s predchádzajúcim modelom.
To znamená, že približne 66% predikcií modelu je správnych.
Hodnota Kappa 0.25 naznačuje umiernenú dohodu nad rámec náhody medzi predpovedanými a skutočnými klasifikáciami.
Senzitivita 0.88 hovorí, že model je celkom dobrý v identifikovaní defenzívnych hráčov ako takých, ale špecifickosť 0.34 ukazuje, že model má menšiu schopnosť správne klasifikovať ofenzívnych hráčov (teda dosť veľký podiel defenzívnych hráčov je nesprávne klasifikovaných ako ofenzívni).
Balanced Accuracy 0.6410 naznačuje celkovú výkonnosť modelu v rovnováhe medzi senzitivitou a špecifickosťou.
Celkovo, na základe výsledkov lineárnej regresie môžeme povedať, že počet striel na bránku a percento úspešnosti striel sú významné príznaky pre predpovedanie počtu gólov.
Na druhej strane, vylepšený model logistické regresie ukazuje lepšiu presnosť v predpovedaní defenzívnych oproti ofenzívnym hráčom, ale stále existuje priestor pre zlepšenie, najmä v špecifickosti a vyváženej presnosti.

Pravé negatívy (TN): 3921 - Počet prípadov, kde model správne predpovedal negatívnu triedu (napr. defenzívni hráči).
Falošné pozitívy (FP): 1980 - Počet prípadov, kde model nesprávne predpovedal pozitívnu triedu (napr. hráči, ktorí boli označení ako ofenzívni, ale v skutočnosti boli defenzívni).
Falošné negatívy (FN): 501 - Počet prípadov, kde model nesprávne predpovedal negatívnu triedu (napr. hráči, ktorí boli označení ako defenzívni, ale boli ofenzívni).
Pravé pozitívy (TP): 1034 - Počet prípadov, kde model správne predpovedal pozitívnu triedu (napr. ofenzívni hráči).

```{r}
# ROC krivka a výpočet AUC
roc_response <- roc(response = test_data$role_oneHot, predictor = as.numeric(predictions))
plot(roc_response)  
```

```{r}
# Výpočet a výpis hodnoty AUC (Area Under the Curve) pre ROC krivku
auc_value <- auc(roc_response)
print(auc_value)
```

ROC krivka ukazuje vzťah medzi citlivosťou a špecificitou pre rôzne prahové hodnoty.

Hodnota AUC (Area Under the Curve) poskytuje jediné číslo, ktoré sumarizuje výkonnosť modelu bez ohľadu na konkrétnu prahovú hodnotu.
Hodnota AUC 0.774 naznačuje dobrú prediktívnu schopnosť modelu, kde hodnoty AUC sú typicky v rozmedzí od 0,5 (žiadna prediktívna schopnosť) do 1 (perfektná prediktívna schopnosť).
Model má hodnotu AUC blízku k 0.8, čo znamená, že má relatívne vysokú schopnosť rozlišovať medzi pozitívnymi a negatívnymi prípadmi.

```{r}
# Výpis celkovej presnosti modelu
cm_overall_accuracy <- cm$overall['Accuracy']
print(paste("Accuracy:", cm_overall_accuracy))
```

Toto číslo hovorí, že 70.2% predpovedí modelu bolo správnych v testovacej sade.
Je to užitočná metrika na rýchle hodnotenie celkového výkonu modelu, ale neberie do úvahy možnú nerovnováhu tried alebo náklady na rôzne typy chýb v predpovediach.

```{r}
# Výpočet a výpis proporcionálneho rozdelenia tried v testovacej sade
proportion_of_1 <- sum(cm$table[2,]) / sum(cm$table)
proportion_of_0 <- sum(cm$table[1,]) / sum(cm$table)
print(paste("Class proportions are: ", proportion_of_1, proportion_of_0, "for 1 and 0, respectively."))
```

Proporcia pozitívnych predpovedí (ofenzívnych hráčov) je približne 21%.
Proporcia negatívnych predpovedí (defenzívnych hráčov) je približne 79%.

Môže to tiež poukazovať na to, že model môže byť viac naklonený k predpovedaniu defenzívnych hráčov, čo môže byť dôsledkom nerovnováhy tried v tréningovej sade.

```{r}
# Výpočet a výpis presnosti (Precision) predpovedí modelu
precision <- cm$table[2,2] / (cm$table[2,2] + cm$table[2,1])
print(paste("Precision:", precision))
```

Zo všetkých prípadov, ktoré model predpovedal ako ofenzívne (ak sú ofenzívni hráči označení ako 'pozitívna' trieda), približne 67% z nich boli skutočne ofenzívni hráči.
Tento údaj je pomerne dobrý a naznačuje, že keď model predpovedá hráča ako ofenzívneho, máme relatívne vysokú dôveru, že táto predpoveď je správna.

```{r}
# Výpočet a výpis citlivosti (Recall) predpovedí modelu
recall <- cm$table[2,2] / (cm$table[2,2] + cm$table[1,2])
print(paste("Recall:", recall))
```

Tento údaj je metrikou, ktorá hodnotí schopnosť modelu správne identifikovať všetky prípady, ktoré sú pozitívne.

V praxi to znamená, že keď sa model snaží identifikovať ofenzívnych hráčov (pokiaľ ofenzívni hráči sú označení ako 'pozitívna' trieda), správne ich odhalí s pravdepodobnosťou 34.3%.
To môže byť interpretované ako relatívne nízka citlivosť, čo naznačuje, že mnoho ofenzívnych hráčov mohlo byť modelom prehliadnutých alebo nesprávne klasifikovaných ako defenzívni hráči.

```{r}
# Sumarizácia modelu a interpretácia koeficientov
model_summary <- summary(model)
print(model_summary)
```

(Intercept): Predstavuje log-odds byť ofenzívnym hráčom, keď sú všetky ostatné príznaky rovné nule.
Jeho záporná hodnota naznačuje, že základná tendencia (bez zohľadnenia príznakov) smeruje skôr k defenzívnym hráčom.

goals: Pozitívny koeficient hovorí, že s každým ďalším gólom sa log-odds byť ofenzívnym hráčom zvyšujú.
To znamená, že viac gólov má výrazný pozitívny vplyv na šancu byť klasifikovaným ako ofenzívny hráč.

assists: Negatívny koeficient pre asistencie ukazuje, že s každou ďalšou asistenciou sa pravdepodobnosť byť ofenzívnym hráčom mierne znižuje.

Pr(\>\|z\|): P-hodnoty pre goals, assists su výrazne nižšie ako 0.05, čo naznačuje, že su statisticky vyznamne

Tento model teda ukazuje, že určité štatistiky (ako počet gólov a plus/minus hodnotenie) sú významné pre identifikáciu ofenzívnych hráčov, zatiaľ čo iné faktory (ako trestné minúty) nemajú štatisticky podložený vplyv na túto klasifikáciu


